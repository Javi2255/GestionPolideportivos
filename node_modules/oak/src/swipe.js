(function (o) {
    "use strict";

    var dx = 0, dy = 0, 
        helpers = {},
        startTouchX = 0,
        startTouchY = 0,
        swipeAngle = 0, 
        touchX = 0,
        touchY = 0,
        strap = {
            swipeOn: function (options) {
                var opts = o.extend({minDist: 10}, options);
                readySwipe(this, opts);
                return this;
            },
            swipeOff: function () {
                removeSwipe(this);
                return this;
            }
        }, 
        that = {};

    function onTouchMove(e) {
        e.preventDefault();
        if (e.touches.length === 1) {
            touchX = e.touches[0].pageX;
            touchY = e.touches[0].pageY;

            dx = touchX - startTouchX;
            dy = touchY - startTouchY;

            // Swipe angle determines direction of swipe
            swipeAngle = Math.atan2(dy, dx) * (180/Math.PI);
        }
    }

    function onTouchStart(e) {
        if (e.touches.length === 1) {
            dx = 0;
            dy = 0;
            swipeAngle = 0;
            startTouchX = e.touches[0].pageX;
            startTouchY = e.touches[0].pageY;
            touchX = startTouchX;
            touchY = startTouchY;
        }
    }

    function endHelper(strap, minDist) {
        return function (e) {
            e.preventDefault();
            var diffX = Math.abs(dx),
                diffY = Math.abs(dy);

            swipeAngle = (swipeAngle < 0) ? 180 + (180 - Math.abs(swipeAngle)) : swipeAngle;
            if (diffY > minDist && swipeAngle < 135 && swipeAngle >= 45) {
                strap.trigger("swipeDown");
            } else if (diffX > minDist && swipeAngle >= 135 && swipeAngle < 225) {
                strap.trigger("swipeLeft");
            } else if (diffY > minDist && swipeAngle >= 225 && swipeAngle < 315) {
                strap.trigger("swipeUp");
            } else if (diffX > minDist && swipeAngle >= 315 && swipeAngle <= 360 ||
                       diffX > minDist && swipeAngle >= 0 && swipeAngle < 45) {
                strap.trigger("swipeRight");
            }
        };
    }

    function readySwipe(strap, opts) {
        var onEnd = endHelper(strap, opts.minDist),
            helpers = {touchend: onEnd, touchmove: onTouchMove, touchstart: onTouchStart};
        strap.data("swipeData", helpers);
        o.each(strap, function (targ) {
            if (targ.addEventListener) {
                toggleListeners(targ, helpers, true);
            }
        });
    }

    function toggleListeners(targ, helpers, add) {
        var pre = (add === true) ? "add" : "remove";
        for (var key in helpers) {
            targ[pre + "EventListener"](key, helpers[key]);
        }
    }

    function removeSwipe(strap) {
        var helpers = strap.data("swipeData");
        if (!o.defined(helpers)) {
            return; 
        }

        o.each(strap, function (targ) {
            if (targ.removeEventListener) {
                toggleListeners(targ, helpers, false);
            }
        });
        strap.removeData("swipeData");
    }

    o.core.expose(strap);
}(oak));
